<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Lowongan Magang</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style tambahan untuk textarea */
        textarea::placeholder {
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased">

    <div class="container mx-auto p-6 md:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Data Lowongan Magang</h1>
            <p class="text-lg text-gray-600 mt-2">Sistem Filter Lowongan Berdasarkan Wilayah</p>
        </header>

        <!-- Area Input Data -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <label for="fileInput" class="block text-lg font-semibold text-gray-700 mb-3">
                Unggah File JSON Lowongan Anda:
            </label>
            <input type="file" id="fileInput" accept=".json"
                   class="block w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-lg file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100
                          cursor-pointer"/>
            
            <!-- Tombol "Proses Data" tidak lagi diperlukan, file diproses saat dipilih -->
            
            <!-- Pesan status (sukses atau error) -->
            <div id="messageArea" class="mt-4 text-sm font-medium"></div>
        </div>

        <!-- Area Filter (Awalnya tersembunyi) -->
        <div id="filterSection" class="hidden mb-6">
            <label for="kabupatenSearch" class="block text-lg font-semibold text-gray-700 mb-3">
                Cari Kabupaten:
            </label>
            <input type="text" id="kabupatenSearch" placeholder="Ketik nama kabupaten..."
                   class="w-full md:w-1/3 p-3 mb-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">

            <label for="kabupatenFilter" class="block text-lg font-semibold text-gray-700 mb-3">
                Filter berdasarkan Kabupaten:
            </label>
            <select id="kabupatenFilter"
                class="w-full md:w-1/3 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <!-- Opsi filter akan diisi oleh JavaScript -->
            </select>
        </div>

        <!-- Area Hasil Lowongan -->
        <div id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Kartu lowongan akan diisi oleh JavaScript -->
        </div>

    </div>

    <script>
        // Variabel global untuk menyimpan semua data lowongan
        let allJobData = [];

        // Menghubungkan elemen HTML ke JavaScript
        const fileInput = document.getElementById('fileInput');
        const messageArea = document.getElementById('messageArea');
        const filterSection = document.getElementById('filterSection');
        const kabupatenSearch = document.getElementById('kabupatenSearch'); // Elemen baru
        const kabupatenFilter = document.getElementById('kabupatenFilter');
        const resultsContainer = document.getElementById('resultsContainer');

        // Event listener untuk input file
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            
            // Reset tampilan
            allJobData = [];
            resultsContainer.innerHTML = '';
            kabupatenFilter.innerHTML = '';
            filterSection.classList.add('hidden');

            if (!file) {
                // Jangan tampilkan error jika pengguna membatalkan pemilihan file
                showMessage('info', 'Silakan pilih file JSON untuk diproses.');
                return;
            }

            if (file.type !== 'application/json') {
                showMessage('error', 'File harus berformat .json');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                const rawData = e.target.result;
                try {
                    const parsedData = JSON.parse(rawData);

                    // Logika untuk menangani dua format input yang mungkin:
                    // 1. Objek dengan key "data" berisi array: { "data": [...] }
                    // 2. Langsung array: [ ... ]
                    if (parsedData && parsedData.data && Array.isArray(parsedData.data)) {
                        allJobData = parsedData.data;
                    } else if (Array.isArray(parsedData)) {
                        allJobData = parsedData;
                    } else {
                        throw new Error('Format data tidak dikenal. Harap file berisi array JSON lowongan, atau objek yang memiliki key "data" berisi array tersebut.');
                    }

                    if (allJobData.length === 0) {
                        throw new Error('Data ditemukan, tetapi tidak ada lowongan di dalamnya.');
                    }

                    showMessage('success', `Berhasil memuat ${allJobData.length} data lowongan dari file ${file.name}.`);
                    
                    // Setelah data berhasil dimuat, isi filter dan tampilkan lowongan
                    populateFilter();
                    renderJobs();
                    filterSection.classList.remove('hidden');

                } catch (error) {
                    showMessage('error', `Gagal memproses JSON dari file. Pastikan formatnya benar. (Error: ${error.message})`);
                    console.error('JSON Parsing Error:', error);
                }
            };

            reader.onerror = () => {
                showMessage('error', `Gagal membaca file: ${reader.error.message}`);
            };

            reader.readAsText(file);
        });

        // Event listener baru untuk search bar
        kabupatenSearch.addEventListener('input', () => {
            const searchTerm = kabupatenSearch.value.toLowerCase();
            const options = kabupatenFilter.options;

            // Loop melalui semua opsi di dropdown
            for (let i = 0; i < options.length; i++) {
                const optionText = options[i].textContent.toLowerCase();
                
                // Tampilkan jika cocok DENGAN pencarian, atau jika itu opsi "Semua Kabupaten"
                if (optionText.includes(searchTerm) || options[i].value === 'all') {
                    options[i].style.display = '';
                } else {
                    // Sembunyikan jika tidak cocok
                    options[i].style.display = 'none';
                }
            }
        });

        // Event listener untuk dropdown filter
        kabupatenFilter.addEventListener('change', renderJobs);

        // Fungsi untuk mengisi dropdown filter dengan data kabupaten yang unik
        function populateFilter() {
            // Menggunakan Set untuk mendapatkan nilai unik
            const kabupatens = new Set(allJobData.map(item => item.perusahaan.nama_kabupaten));
            
            // Menambahkan opsi "Semua"
            kabupatenFilter.innerHTML = '<option value="all">Semua Kabupaten</option>';
            
            // Menambahkan setiap kabupaten ke dropdown
            kabupatens.forEach(kab => {
                if(kab) { // Memastikan bukan null atau undefined
                    const option = document.createElement('option');
                    option.value = kab;
                    option.textContent = kab;
                    kabupatenFilter.appendChild(option);
                }
            });
        }

        // Fungsi untuk menampilkan kartu-kartu lowongan berdasarkan filter
        function renderJobs() {
            const selectedKabupaten = kabupatenFilter.value;
            resultsContainer.innerHTML = ''; // Kosongkan hasil sebelumnya

            // Filter data berdasarkan pilihan dropdown
            const filteredData = selectedKabupaten === 'all' 
                ? allJobData 
                : allJobData.filter(item => item.perusahaan.nama_kabupaten === selectedKabupaten);

            if (filteredData.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-600 col-span-full text-center">Tidak ada lowongan yang sesuai dengan filter ini.</p>';
                return;
            }

            // Buat kartu untuk setiap item lowongan yang sudah difilter
            filteredData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col justify-between';

                // Parsing 'program_studi' yang merupakan string JSON
                let programStudiHtml = '<p class="text-sm text-gray-500">Program studi tidak tersedia.</p>';
                if (item.program_studi) {
                    try {
                        const studiList = JSON.parse(item.program_studi);
                        if (Array.isArray(studiList) && studiList.length > 0) {
                            // Ambil 'title' dari setiap objek dan gabungkan
                            const titles = studiList.map(s => s.title).join(', ');
                            programStudiHtml = `<p class="text-sm text-gray-600"><span class="font-semibold">Program Studi:</span> ${titles}</p>`;
                        }
                    } catch (e) {
                        console.error('Gagal parse program_studi:', e);
                        programStudiHtml = '<p class="text-sm text-red-500">Gagal memuat program studi.</p>';
                    }
                }

                // Mengisi konten kartu
                card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-blue-800 mb-2">${item.posisi}</h3>
                        <p class="text-md font-semibold text-gray-700">${item.perusahaan.nama_perusahaan}</p>
                        <p class="text-sm text-gray-500 mb-4">${item.perusahaan.nama_kabupaten}, ${item.perusahaan.nama_provinsi}</p>
                        <div class="border-t border-gray-200 pt-3 mt-3">
                            ${programStudiHtml}
                        </div>
                    </div>
                    <button 
                        data-idposisi="${item.id_posisi}" 
                        class="apply-button mt-6 w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Lihat Detail & Lamar
                    </button>
                `;
                resultsContainer.appendChild(card);
            });
        }

        // Event listener untuk tombol "Lamar" (menggunakan event delegation)
        resultsContainer.addEventListener('click', (e) => {
            // Cek apakah yang diklik adalah tombol "apply-button"
            if (e.target.classList.contains('apply-button')) {
                const idPosisi = e.target.dataset.idposisi;
                if (idPosisi) {
                    const url = `https://maganghub.kemnaker.go.id/lowongan/view/${idPosisi}`;
                    // Buka URL di tab baru
                    window.open(url, '_blank');
                }
            }
        });

        // Fungsi helper untuk menampilkan pesan status
        function showMessage(type, message) {
            messageArea.textContent = message;
            if (type === 'success') {
                messageArea.className = 'mt-4 text-sm font-medium text-green-600';
            } else if (type === 'error') {
                messageArea.className = 'mt-4 text-sm font-medium text-red-600';
            } else {
                messageArea.className = 'mt-4 text-sm font-medium text-gray-600';
            }
        }
    </script>
</body>
</html>